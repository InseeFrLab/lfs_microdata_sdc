---
title: "Data exploration of LFS armenian data"
author: "MS4"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile #cayman
    highlight: github
    toc: true
    toc_depth: 5
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo = FALSE}
packs <- c("xlsx","dplyr","tidyr","sdcMicro","archive")

p <- sapply(packs, install.packages)
p <- lapply(packs,function(p) suppressPackageStartupMessages(library(p,character.only = TRUE)))
rm(p)
# rm(list=ls())
```

### Prepare data :

```{r}

download.file(
  destfile = "data/lfs_micro_arm_2020.7z",
  url = "https://www.armstat.am/file/doc/99528268.7z"
)
archive::archive_extract("data/lfs_micro_arm_2020.7z",dir = "data/")
# To read it 
lfs_micro_arm_2020 <- haven::read_spss("data/LFS_2020_2020 Dataset_Residents.sav")

lfs_micro_arm_2020 <-
  lfs_micro_arm_2020 %>% 
  mutate(
    id_hh = as.numeric(substr(IDmem,1,nchar(IDmem)-2)), # concatenation of month + questionnaire_num
    id_indiv = substr(IDmem,nchar(IDmem)-1,nchar(IDmem))
  ) 

```

Household identification :

A6_month : month of survey
A1 : questionnaire number

Quasi-identifying variables :

- B5, B6 : Date of birth
- B3 : Gender
- A3 : Geographical Area (Marz)
- B11 : Marital Status 
- B7 : Diploma

Sensitive variables 

- E15 : Income
- C2 : country of citizenship
- LU1_unemployed : unemployment

```{r}
lfs_micro_subset <-
  lfs_micro_arm_2020 %>%
  select(id_hh,id_indiv,B5,B6,B3,A3,B11,B7,E15,C2,LU1_unemployed,WeightsCalib_year) %>% 
  mutate(
    dob = paste0(B5,"_",B6), # date of birth
    LU1_unemployed = as.factor(ifelse(is.na(LU1_unemployed),0,1)) 
         ) %>% 
  select(-B5,-B6)
```


### A simple way to apply PRAM

```{r}
pram_1 <- pram(
  lfs_micro_subset,
  variables = "LU1_unemployed"
)

str(pram_1,1) # It is not a sdc Micro object, list of variables xwith attributes

attributes(pram_1)
attr(pram_1,"summary")
attr(pram_1,"pram_params")

# build data based on the results
data_pram <- 
  do.call(cbind,pram_1) %>%
  data.frame()

# Original count
data_pram %>% 
  group_by(LU1_unemployed) %>% 
  count()

# the modify variable is suffixed by "_pram"
data_pram %>% 
  group_by(LU1_unemployed_pram) %>% 
  count()

data_pram %>% 
  group_by(LU1_unemployed,LU1_unemployed_pram) %>% 
  count() %>% 
  ungroup() %>% 
  pivot_wider(
    names_from = LU1_unemployed_pram,
    values_from = n
    )
```

### Define the pram parameters  

You can choose ypour matrix, be careful it is not invariant pram anymore, count are biased
```{r}


mat <- matrix(c(0.3,0.7,0.2,0.8),nrow = 2,byrow = TRUE)
row.names(mat) <- colnames(mat) <- levels(lfs_micro_subset$LU1_unemployed)


pram <- pram(
  lfs_micro_subset,
  variables = "LU1_unemployed",
  pd = mat,
  alpha = NA
)

```

Invariant Pram is automatically applied if only one coefficient is given for pd  (minimal diagonal value coefficient) (it can be seen as the level of utility we want to keep)

The alpha parameters is linked to the invariant pram method see "The Analysis of Data Perturbed by PRAM
A.D.L. van den Hout" and give also an idea of the level of pertubation we want to achieve. it lies between the 0,1 intervals, default value  is 0.5


```{r}
set.seed(12345)

pram <- pram(
  lfs_micro_subset,
  variables = "LU1_unemployed",
  pd = c(0.5), # can be a matrix or a minimal diagonal value
  alpha = 0.2  # must lie between 0 and 1, its a parameter we can choose for invariant PRAM
)


attr(pram,"pram_params")


pram <- pram(
  lfs_micro_subset,
  variables = "LU1_unemployed",
  pd = c(0.5), # can be a matrix or a minimal diagonal value
  alpha = 0.9  # must lie between 0 and 1, its a parameter we can choose for invariant PRAM
)


attr(pram,"pram_params")
# pd = param in entry, RS, sresulting P matrix
```

### How to perform stratification ?

```{r}
set.seed(1234)
pram <- pram(
  lfs_micro_subset,
  variables = "LU1_unemployed",
  pd = 0.4  # in order to apply PRAM independtly on the category of Gender ..
)

pram2 <- pram(
  lfs_micro_subset,
  variables = "LU1_unemployed",
  pd = 0.4,
  strata_variables = "B3"  # in order to apply PRAM independtly on the category of Gender ..
)

# original count
do.call(cbind,pram) %>%
  as.data.frame() %>% 
  group_by(B3,LU1_unemployed) %>% 
  count()

# count pram 1
do.call(cbind,pram) %>%
  as.data.frame() %>% 
  group_by(B3,LU1_unemployed_pram) %>% 
  count()

# count pram 2
do.call(cbind,pram2) %>%
  as.data.frame() %>% 
  group_by(B3,LU1_unemployed_pram) %>% 
  count()

attr(pram,"pram_params")
```


### How to measure the information loss ?
One can calculate for eachcategory the quantity $P(X)$
```{r}


```



### Applying PRAM on a SDC_micro_obj 

Prepare the sdc micro object
```{r}
selectedKeyVars = c('dob','A3','B3','B7','B11')

# weight variable
selectedWeightVar = c('WeightsCalib_year')

# selected pram variables
selectedPramVars = c('LU1_unemployed')

# household id variable (cluster)
selectedHouseholdID = c('id_hh')

sdcInitial <- createSdcObj(
  dat = lfs_micro_subset,
  keyVars     = selectedKeyVars,
  weightVar   = selectedWeightVar,
  pramVars    = selectedPramVars,
  hhId        = selectedHouseholdID,
  seed = 12345
)

str(sdcInitial,2)
```

```{r}

pram_2  <- pram(sdcInitial,variables = NULL,strata_variables = NULL)
str(pram_2,1)
# If argument 'variables' is NULL, all variables from slot 'pramVars' will be used if possible.

pram_2@origData %>%
  group_by(LU1_unemployed) %>%
  count()

# PRAM count 
pram_2@manipPramVars %>%
  group_by(LU1_unemployed) %>%
  count()

# What happens ?
table(
  pram_2@manipPramVars$LU1_unemployed,
  pram_2@origData$LU1_unemployed
  )
```

Which parameters has been used by default ?
```{r}

sdcInitial@pram
pram_2@pram

# P Matrix
pram_2@pram$params$LU1_unemployed$Rs

# Transitions
pram_2@pram$transitions$LU1_unemployed

```










###To DO
- strata -> double matirices possible ?
- Regarder SUDA 
- Test données synthétiques





